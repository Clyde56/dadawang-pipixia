const UI = (function() {
    let selectedMood = 'happy';
    let currentPage = 'home';
    let editingAnniversaryId = null;

    // é¡µé¢å…ƒç´ å¼•ç”¨
    const pages = {
        home: document.getElementById('main-screen'),
        diary: document.getElementById('page-diary'),
        anniversaries: document.getElementById('page-anniversaries'),
        capsule: document.getElementById('page-capsule'),
        photos: document.getElementById('page-photos'),
        backup: document.getElementById('page-backup')
    };

    function init() {
        initEventListeners();
    }

    function initEventListeners() {
        // å¿ƒæƒ…é€‰æ‹©
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedMood = this.dataset.mood;
            });
        });

        // å¿«æ·æ“ä½œæŒ‰é’®
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                switch(action) {
                    case 'diary': openDiaryModal(); break;
                    case 'moment': openMomentModal(); break;
                    case 'capsule': openCapsuleModal(); break;
                    case 'lock': lockScreen(); break;
                }
            });
        });

        // å…³é—­æ¨¡æ€æ¡†
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeAllModals);
        });

        document.getElementById('modal-container').addEventListener('click', function(e) {
            if (e.target === this) closeAllModals();
        });

        // å‘å¸ƒæ—¥è®°
        document.getElementById('publish-diary').addEventListener('click', handlePublishDiary);
        
        // æ—¥è®°å­—æ•°ç»Ÿè®¡
        document.getElementById('diary-content').addEventListener('input', function() {
            document.getElementById('word-count').textContent = this.value.length;
        });

        // å‘å¸ƒåŠ¨æ€
        document.getElementById('publish-moment').addEventListener('click', handlePublishMoment);

        // å¿«æ·æ¶ˆæ¯
        document.querySelectorAll('.quick-msg-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('moment-content').value = this.dataset.msg;
            });
        });

        // çºªå¿µæ—¥ - é¦–é¡µæ·»åŠ æŒ‰é’®
        document.getElementById('add-anniversary-btn').addEventListener('click', function() {
            openAnniversaryModal();
        });

        // çºªå¿µæ—¥ - é¡µé¢æ·»åŠ æŒ‰é’®
        document.querySelector('.add-anniversary-page-btn')?.addEventListener('click', function() {
            openAnniversaryModal();
        });

        // ä¿å­˜çºªå¿µæ—¥
        document.getElementById('save-anniversary-btn').addEventListener('click', handleSaveAnniversary);

        // åˆ é™¤çºªå¿µæ—¥
        document.getElementById('delete-anniversary-btn').addEventListener('click', handleDeleteAnniversary);

        // è®¾ç½®æŒ‰é’®
        document.getElementById('settings-btn').addEventListener('click', function() {
            const profile = Storage.getUserProfile();
            document.getElementById('setting-my-name').value = profile.myName || '';
            document.getElementById('setting-partner-name').value = profile.partnerName || '';
            document.getElementById('setting-love-date').value = profile.startDate || '';
            openModal('settings-modal');
        });

        // ä¿å­˜è®¾ç½®
        document.getElementById('save-settings-btn').addEventListener('click', handleSaveSettings);

        // å¯¼å‡ºæ•°æ®
        document.getElementById('export-data-btn').addEventListener('click', function() {
            Storage.exportData();
            showToast('æ­£åœ¨å¯¼å‡º...');
        });

        // é‡ç½®æ•°æ®
        document.getElementById('reset-data-btn').addEventListener('click', function() {
            Storage.resetData();
        });

        // ä¾§è¾¹æ å¯¼èˆª
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                navigateTo(page);
                document.getElementById('drawer').classList.remove('active');
            });
        });

        // ä¾§è¾¹æ èœå•æŒ‰é’®
        document.getElementById('menu-btn').addEventListener('click', function() {
            document.getElementById('drawer').classList.add('active');
        });

        // ä¾§è¾¹æ é®ç½©å…³é—­
        document.querySelector('.drawer-overlay')?.addEventListener('click', function() {
            document.getElementById('drawer').classList.remove('active');
        });

        // è¿”å›æŒ‰é’®
        document.querySelectorAll('.back-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                navigateTo('home');
            });
        });

        // ========== é¡µé¢ç‰¹å®šåŠŸèƒ½ ==========

        // æ—¥è®°æœ¬é¡µé¢ - æ·»åŠ æ—¥è®°æŒ‰é’®
        document.querySelector('.add-diary-btn')?.addEventListener('click', openDiaryModal);

        // æ—¥è®°æœ¬é¡µé¢ - ç­›é€‰
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                renderDiaryList(this.dataset.filter);
            });
        });

        // æ—¶å…‰èƒ¶å›Šé¡µé¢ - åˆ‡æ¢æ ‡ç­¾
        document.querySelectorAll('.capsule-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.capsule-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                renderCapsuleList(this.dataset.capsuleTab);
            });
        });

        // æ—¶å…‰èƒ¶å›Šé¡µé¢ - æ·»åŠ æŒ‰é’®
        document.querySelector('.add-capsule-btn')?.addEventListener('click', function() {
            document.getElementById('capsule-open-date').value = '';
            document.getElementById('capsule-content').value = '';
            openModal('capsule-modal');
            // åˆ‡æ¢åˆ°åˆ›å»ºé¢æ¿
            document.querySelectorAll('#capsule-modal .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === 'create');
            });
            document.getElementById('create-capsule-panel').classList.remove('hidden');
            document.getElementById('capsule-list-panel').classList.add('hidden');
        });

        // åˆ›å»ºèƒ¶å›Š
        document.getElementById('create-capsule-btn').addEventListener('click', handleCreateCapsule);

        // èƒ¶å›Šåˆ—è¡¨Tabåˆ‡æ¢
        document.querySelectorAll('#capsule-modal .tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('#capsule-modal .tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const isCreate = this.dataset.tab === 'create';
                document.getElementById('create-capsule-panel').classList.toggle('hidden', !isCreate);
                document.getElementById('capsule-list-panel').classList.toggle('hidden', isCreate);
                if (!isCreate) {
                    Capsule.renderList(Capsule.getList(), document.getElementById('capsule-list-panel'));
                }
            });
        });

        // åŠ¨æ€ - å…¨éƒ¨æŒ‰é’®
        document.getElementById('all-moments-btn')?.addEventListener('click', showAllMoments);

        // ç›¸å†Œä¸Šä¼ 
        document.querySelector('.upload-photo-btn')?.addEventListener('click', function() {
            document.getElementById('photos-page-upload').click();
        });

        document.getElementById('photos-page-upload')?.addEventListener('change', function(e) {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    Storage.addPhoto({ data: evt.target.result });
                    renderPhotoGrid();
                    showToast('ç…§ç‰‡å·²ä¸Šä¼ ');
                };
                reader.readAsDataURL(file);
            });
        });

        // ç…§ç‰‡ä¸Šä¼ ï¼ˆé¦–é¡µæ¨¡æ€æ¡†ï¼‰
        document.getElementById('diary-photos')?.addEventListener('change', function(e) {
            const preview = document.getElementById('photo-preview');
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const img = document.createElement('img');
                    img.src = evt.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // ç…§ç‰‡ä¸Šä¼ ï¼ˆæ¨¡æ€æ¡†ï¼‰
        document.getElementById('photo-upload-input')?.addEventListener('change', function(e) {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    Storage.addPhoto({ data: evt.target.result });
                    refreshPhotos();
                    showToast('ç…§ç‰‡å·²ä¸Šä¼ ');
                };
                reader.readAsDataURL(file);
            });
        });

        // å¤‡ä»½é¡µé¢æŒ‰é’®
        document.getElementById('backup-export-btn')?.addEventListener('click', function() {
            Storage.exportData();
            showToast('æ­£åœ¨å¯¼å‡ºå¤‡ä»½...');
        });

        document.getElementById('backup-import-btn')?.addEventListener('click', function() {
            document.getElementById('backup-import-input').click();
        });

        document.getElementById('backup-import-input')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼')) {
                            localStorage.setItem('dadawang_pipixia_data', JSON.stringify(data));
                            showToast('å¯¼å…¥æˆåŠŸï¼');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } catch (err) {
                        showToast('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('backup-reset-btn')?.addEventListener('click', function() {
            Storage.resetData();
        });

        // é”å±ç‚¹å‡»è§£é”
        document.getElementById('lock-screen')?.addEventListener('click', unlockScreen);
    }

    // ========== é¡µé¢å¯¼èˆª ==========
    function navigateTo(pageName) {
        if (!pages[pageName]) return;
        
        currentPage = pageName;
        
        // éšè—æ‰€æœ‰é¡µé¢
        Object.values(pages).forEach(page => {
            if (page) {
                page.classList.add('hidden');
                page.classList.remove('active');
            }
        });
        
        // æ˜¾ç¤ºç›®æ ‡é¡µé¢
        const targetPage = pages[pageName];
        targetPage.classList.remove('hidden');
        setTimeout(() => targetPage.classList.add('active'), 10);
        
        // åˆ·æ–°é¡µé¢å†…å®¹
        switch(pageName) {
            case 'diary':
                renderDiaryList('all');
                break;
            case 'anniversaries':
                renderAnniversaryList();
                break;
            case 'capsule':
                renderCapsuleList('unopened');
                break;
            case 'photos':
                renderPhotoGrid();
                break;
            case 'home':
                refreshAnniversaries();
                refreshMoments();
                break;
        }
    }

    // ========== æ¨¡æ€æ¡† ==========
    function openDiaryModal() {
        document.getElementById('diary-content').value = '';
        document.getElementById('photo-preview').innerHTML = '';
        document.getElementById('word-count').textContent = '0';
        // é‡ç½®å¿ƒæƒ…
        selectedMood = 'happy';
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.mood-btn[data-mood="happy"]')?.classList.add('active');
        openModal('diary-modal');
    }

    function openMomentModal() {
        document.getElementById('moment-content').value = '';
        openModal('moment-modal');
    }

    function openCapsuleModal() {
        document.getElementById('capsule-content').value = '';
        document.getElementById('capsule-open-date').value = '';
        openModal('capsule-modal');
    }

    function openAnniversaryModal(anniversary = null) {
        editingAnniversaryId = anniversary ? anniversary.id : null;
        document.getElementById('anniversary-modal-title').textContent = anniversary ? 'ç¼–è¾‘çºªå¿µæ—¥' : 'æ·»åŠ çºªå¿µæ—¥';
        document.getElementById('anniversary-name').value = anniversary ? anniversary.name : '';
        document.getElementById('anniversary-date').value = anniversary ? anniversary.date : '';
        document.getElementById('anniversary-type').value = anniversary ? anniversary.type : 'custom';
        document.getElementById('delete-anniversary-btn').style.display = anniversary ? 'block' : 'none';
        openModal('anniversary-modal');
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            document.getElementById('modal-container').classList.add('active');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    }

    function closeAllModals() {
        document.getElementById('modal-container').classList.remove('active');
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        });
    }

    // ========== å¤„ç†å‡½æ•° ==========
    function handlePublishDiary() {
        const content = document.getElementById('diary-content').value;
        const preview = document.getElementById('photo-preview');
        const images = preview.querySelectorAll('img');
        if (!content.trim()) {
            showToast('è¯·è¾“å…¥æ—¥è®°å†…å®¹');
            return;
        }
        const result = Diary.create(content, selectedMood, Array.from(images).map(img => img.src));
        if (result.success) {
            showToast('æ—¥è®°å·²ä¿å­˜');
            closeAllModals();
            refreshMoments();
        } else {
            showToast(result.message);
        }
    }

    function handlePublishMoment() {
        const content = document.getElementById('moment-content').value;
        if (!content.trim()) {
            showToast('è¯·è¾“å…¥åŠ¨æ€å†…å®¹');
            return;
        }
        const result = Moments.publish(content);
        if (result.success) {
            showToast('åŠ¨æ€å·²å‘å¸ƒ');
            closeAllModals();
            refreshMoments();
        } else {
            showToast(result.message);
        }
    }

    function handleSaveAnniversary() {
        const name = document.getElementById('anniversary-name').value;
        const date = document.getElementById('anniversary-date').value;
        const type = document.getElementById('anniversary-type').value;
        
        if (!name || !date) {
            showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
        }
        
        if (editingAnniversaryId) {
            // ç¼–è¾‘
            const anniversaries = Storage.getAnniversaries();
            const anniversary = anniversaries.find(a => a.id === editingAnniversaryId);
            if (anniversary) {
                anniversary.name = name;
                anniversary.date = date;
                anniversary.type = type;
                Storage.saveData({ ...Storage.getData(), anniversaries });
                showToast('çºªå¿µæ—¥å·²æ›´æ–°');
            }
        } else {
            // æ–°å¢
            Storage.addAnniversary({ name, date, type });
            showToast('çºªå¿µæ—¥å·²æ·»åŠ ');
        }
        
        closeAllModals();
        refreshAnniversaries();
        renderAnniversaryList();
    }

    function handleDeleteAnniversary() {
        if (editingAnniversaryId && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
            Storage.deleteAnniversary(editingAnniversaryId);
            showToast('çºªå¿µæ—¥å·²åˆ é™¤');
            closeAllModals();
            refreshAnniversaries();
            renderAnniversaryList();
        }
    }

    function handleSaveSettings() {
        Storage.saveUserProfile({
            myName: document.getElementById('setting-my-name').value,
            partnerName: document.getElementById('setting-partner-name').value,
            startDate: document.getElementById('setting-love-date').value
        });
        showToast('è®¾ç½®å·²ä¿å­˜');
        closeAllModals();
        location.reload();
    }

    function handleCreateCapsule() {
        const content = document.getElementById('capsule-content').value;
        const openDate = document.getElementById('capsule-open-date').value;
        if (!content.trim()) {
            showToast('è¯·è¾“å…¥èƒ¶å›Šå†…å®¹');
            return;
        }
        if (!openDate) {
            showToast('è¯·é€‰æ‹©å¼€å¯æ—¥æœŸ');
            return;
        }
        if (new Date(openDate) <= new Date()) {
            showToast('å¼€å¯æ—¥æœŸå¿…é¡»å¤§äºä»Šå¤©');
            return;
        }
        const result = Capsule.create(content, openDate);
        if (result.success) {
            showToast('èƒ¶å›Šå·²å°å­˜');
            closeAllModals();
        } else {
            showToast(result.message);
        }
    }

    // ========== æ¸²æŸ“å‡½æ•° ==========
    function renderDiaryList(filter = 'all') {
        const container = document.getElementById('diary-list-page');
        if (!container) return;
        
        let diaries = Diary.getAll();
        const now = new Date();
        
        // ç­›é€‰
        switch(filter) {
            case 'today':
                diaries = diaries.filter(d => d.createdAt.startsWith(now.toISOString().split('T')[0]));
                break;
            case 'week':
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                diaries = diaries.filter(d => new Date(d.createdAt) >= weekStart);
                break;
            case 'month':
                diaries = diaries.filter(d => d.createdAt.startsWith(now.toISOString().slice(0, 7)));
                break;
        }
        
        if (diaries.length === 0) {
            container.innerHTML = `
                <div class="empty-state-page">
                    <div class="empty-icon">ğŸ“”</div>
                    <p>è¿˜æ²¡æœ‰æ—¥è®°</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = diaries.map(diary => {
            const date = new Date(diary.createdAt);
            const moodEmoji = Diary.MOOD_ICONS[diary.mood] || 'ğŸ˜Š';
            const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            
            let imagesHtml = '';
            if (diary.images && diary.images.length > 0) {
                imagesHtml = '<div class="diary-card-full-images">' + 
                    diary.images.slice(0, 4).map(img => `<img src="${img}" onclick="UI.viewPhoto('${img}')">`).join('') +
                    '</div>';
            }
            
            return `
                <div class="diary-card-full" data-id="${diary.id}">
                    <div class="diary-card-full-header">
                        <span class="diary-card-full-date">${dateStr}</span>
                        <span class="diary-card-full-mood">${moodEmoji}</span>
                    </div>
                    <div class="diary-card-full-content">${escapeHtml(diary.content)}</div>
                    ${imagesHtml}
                    <div class="diary-card-full-actions">
                        <button class="delete-btn" onclick="UI.deleteDiary('${diary.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderAnniversaryList() {
        const container = document.getElementById('anniversary-full-list');
        if (!container) return;
        
        const anniversaries = Storage.getAnniversaries();
        
        if (anniversaries.length === 0) {
            container.innerHTML = `
                <div class="empty-state-page">
                    <div class="empty-icon">ğŸ“…</div>
                    <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = anniversaries.map(a => {
            const info = Timer.getNextAnniversary(a.date);
            const icons = { anniversary: 'ğŸ’•', birthday: 'ğŸ‚', custom: 'ğŸ“Œ' };
            
            return `
                <div class="anniversary-card-full" onclick="UI.editAnniversary('${a.id}')">
                    <div class="anniversary-card-full-icon">${icons[a.type] || 'ğŸ“Œ'}</div>
                    <div class="anniversary-card-full-info">
                        <div class="anniversary-card-full-name">${escapeHtml(a.name)}</div>
                        <div class="anniversary-card-full-date">${a.date}</div>
                    </div>
                    <div class="anniversary-card-full-countdown">
                        <div class="anniversary-card-full-countdown-days">${info.daysUntil === 0 ? 'ä»Šå¤©' : info.daysUntil}</div>
                        <div class="anniversary-card-full-countdown-label">${info.daysUntil === 0 ? '' : 'å¤©å'}</div>
                    </div>
                    <button class="anniversary-card-full-delete" onclick="event.stopPropagation(); UI.deleteAnniversary('${a.id}')">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            `;
        }).join('');
    }

    function renderCapsuleList(status = 'unopened') {
        const container = document.getElementById('capsule-full-list');
        if (!container) return;
        
        let capsules = Capsule.getList();
        
        if (status === 'unopened') {
            capsules = capsules.filter(c => !c.isOpened);
        } else {
            capsules = capsules.filter(c => c.isOpened);
        }
        
        if (capsules.length === 0) {
            container.innerHTML = `
                <div class="empty-state-page">
                    <div class="empty-icon">â³</div>
                    <p>${status === 'unopened' ? 'è¿˜æ²¡æœ‰æ—¶å…‰èƒ¶å›Š' : 'è¿˜æ²¡æœ‰å¼€å¯çš„èƒ¶å›Š'}</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = capsules.map(capsule => {
            const canOpen = Capsule.canOpen(capsule);
            let statusClass, statusText;
            
            if (capsule.isOpened) {
                statusClass = 'opened';
                statusText = 'å·²å¼€å¯';
            } else if (canOpen) {
                statusClass = 'ready';
                statusText = 'å¯å¼€å¯';
            } else {
                statusClass = 'waiting';
                statusText = 'å¾…å¼€å¯';
            }
            
            return `
                <div class="capsule-card-full ${capsule.isOpened ? 'opened' : ''}">
                    <div class="capsule-card-full-header">
                        <span class="capsule-card-full-date">å¼€å¯æ—¥æœŸ: ${capsule.openDate}</span>
                        <span class="capsule-card-full-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="capsule-card-full-content">${capsule.isOpened ? escapeHtml(capsule.content) : 'å†…å®¹å·²åŠ å¯†ï¼Œå¼€å¯åå¯è§'}</div>
                    ${canOpen && !capsule.isOpened ? 
                        `<button class="capsule-card-full-btn" onclick="UI.openCapsule('${capsule.id}')">å¼€å¯èƒ¶å›Š</button>` : 
                        ''}
                </div>
            `;
        }).join('');
    }

    function renderPhotoGrid() {
        const container = document.getElementById('photo-full-grid') || document.getElementById('photo-grid');
        if (!container) return;
        
        const photos = Storage.getPhotos();
        
        if (photos.length === 0) {
            container.innerHTML = `
                <div class="empty-state-page">
                    <div class="empty-icon">ğŸ–¼ï¸</div>
                    <p>è¿˜æ²¡æœ‰ç…§ç‰‡</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = photos.map(p => 
            `<img src="${p.data}" onclick="UI.viewPhoto('${p.data}')">`
        ).join('');
    }

    function showAllMoments() {
        const moments = Storage.getMoments();
        let html = '<div class="moments-full-list" style="max-height:60vh;overflow-y:auto;">';
        moments.forEach(m => {
            html += Moments.renderCard(m);
        });
        html += '</div>';
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.maxWidth = '500px';
        modal.innerHTML = `
            <div class="modal-header">
                <h3>å…¨éƒ¨åŠ¨æ€</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">Ã—</button>
            </div>
            <div class="modal-body">${html}</div>
        `;
        document.getElementById('modal-container').classList.add('active');
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('active'), 10);
    }

    // ========== å…¬å¼€æ–¹æ³• ==========
    function deleteDiary(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
            Diary.remove(id);
            showToast('æ—¥è®°å·²åˆ é™¤');
            renderDiaryList(document.querySelector('.filter-tab.active')?.dataset.filter || 'all');
        }
    }

    function deleteAnniversary(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
            Storage.deleteAnniversary(id);
            showToast('çºªå¿µæ—¥å·²åˆ é™¤');
            refreshAnniversaries();
            renderAnniversaryList();
        }
    }

    function editAnniversary(id) {
        const anniversaries = Storage.getAnniversaries();
        const anniversary = anniversaries.find(a => a.id === id);
        if (anniversary) {
            openAnniversaryModal(anniversary);
        }
    }

    function openCapsule(id) {
        const capsule = Capsule.getList().find(c => c.id === id);
        if (capsule) {
            Storage.openCapsule(id);
            showToast('èƒ¶å›Šå·²å¼€å¯');
            renderCapsuleList('unopened');
        }
    }

    function viewPhoto(src) {
        const viewer = document.createElement('div');
        viewer.className = 'photo-viewer';
        viewer.innerHTML = `
            <button class="photo-viewer-close">Ã—</button>
            <img src="${src}">
        `;
        document.body.appendChild(viewer);
        setTimeout(() => viewer.classList.add('active'), 10);
        viewer.querySelector('.photo-viewer-close').addEventListener('click', () => {
            viewer.classList.remove('active');
            setTimeout(() => viewer.remove(), 300);
        });
    }

    // ========== æ›´æ–°æ˜¾ç¤º ==========
    function updateTimerDisplay(time) {
        const yearsEl = document.getElementById('years');
        const monthsEl = document.getElementById('months');
        const daysEl = document.getElementById('days');
        const hoursEl = document.getElementById('hours');
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');
        const totalDaysEl = document.getElementById('total-days');
        
        if (yearsEl) yearsEl.textContent = time.years;
        if (monthsEl) monthsEl.textContent = time.months;
        if (daysEl) daysEl.textContent = time.days;
        if (hoursEl) hoursEl.textContent = String(time.hours).padStart(2, '0');
        if (minutesEl) minutesEl.textContent = String(time.minutes).padStart(2, '0');
        if (secondsEl) secondsEl.textContent = String(time.seconds).padStart(2, '0');
        if (totalDaysEl) totalDaysEl.textContent = time.totalDays;
    }

    function refreshAnniversaries() {
        const container = document.getElementById('anniversary-list');
        if (!container) return;
        
        const anniversaries = Storage.getAnniversaries();
        if (anniversaries.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰çºªå¿µæ—¥</p></div>';
            return;
        }
        
        container.innerHTML = anniversaries.slice(0, 3).map(a => {
            const info = Timer.getNextAnniversary(a.date);
            return `
                <div class="anniversary-item">
                    <div class="anniversary-icon"><i class="ri-calendar-event-line"></i></div>
                    <div class="anniversary-info">
                        <div class="anniversary-name">${escapeHtml(a.name)}</div>
                        <div class="anniversary-date">${a.date}</div>
                    </div>
                    <div class="anniversary-countdown">
                        <div class="countdown-days">${info.daysUntil === 0 ? 'ä»Šå¤©' : info.daysUntil}</div>
                        <div class="countdown-label">${info.daysUntil === 0 ? '' : 'å¤©å'}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function refreshMoments() {
        const container = document.getElementById('moments-list');
        if (!container) return;
        Moments.renderList(Moments.getList(5), container);
    }

    function refreshPhotos() {
        renderPhotoGrid();
    }

    function lockScreen() {
        document.getElementById('main-screen')?.classList.add('hidden');
        document.getElementById('lock-screen')?.classList.remove('hidden');
    }

    function unlockScreen() {
        document.getElementById('lock-screen')?.classList.add('hidden');
        document.getElementById('main-screen')?.classList.remove('hidden');
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.querySelector('.toast-message').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    return {
        init,
        navigateTo,
        updateTimerDisplay,
        refreshAnniversaries,
        refreshMoments,
        refreshPhotos,
        deleteDiary,
        deleteAnniversary,
        editAnniversary,
        openCapsule,
        viewPhoto,
        showToast
    };
})();
